{"version":3,"sources":["../../../src/store/server/pageRendering.js"],"names":["language","api","ajaxBaseUrl","getHead","helmet","rewind","title","toString","meta","link","script","style","htmlAttributes","base","noscript","getReferrerCookieOptions","maxAge","httpOnly","signed","secure","isHttps","sameSite","renderError","req","res","err","error","url","stack","status","send","message","getAppHtml","store","location","context","html","getPlaceholder","placeholder","head_start","head_end","body_start","body_end","placeholders","length","filter","p","place","map","value","join","renderPage","themeText","appHtml","state","getState","head","replace","JSON","stringify","protocol","full_url","hostname","referrer_url","get","undefined","REFERRER_COOKIE_OPTIONS","signedCookies","cookie","landing_url","httpStatusCode","app","currentPage","type","pageRendering","then","themeSettings","text","catch"],"mappings":";;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;AACA;;AACA;;AACA;;;;AACA;;AACA;;;;AACA;;AACA;;;;AACA;;;;AACA;;AACA;;AACA;;;;;;AAEA,yBAAa;AACZA,WAAU,mBAAeA,QADb;AAEZC,MAAK,4BAAkB;AACtBC,eAAa,mBAAeA;AADN,EAAlB;AAFO,CAAb;;AAOA,IAAMC,UAAU,SAAVA,OAAU,GAAM;AACrB,KAAMC,SAAS,sBAAOC,MAAP,EAAf;AACA,QAAO;AACNC,SAAOF,OAAOE,KAAP,CAAaC,QAAb,EADD;AAENC,QAAMJ,OAAOI,IAAP,CAAYD,QAAZ,EAFA;AAGNE,QAAML,OAAOK,IAAP,CAAYF,QAAZ,EAHA;AAING,UAAQN,OAAOM,MAAP,CAAcH,QAAd,EAJF;AAKNI,SAAOP,OAAOO,KAAP,CAAaJ,QAAb,EALD;AAMNK,kBAAgBR,OAAOQ,cAAP,CAAsBL,QAAtB,EANV;AAONM,QAAMT,OAAOS,IAAP,CAAYN,QAAZ,EAPA;AAQNO,YAAUV,OAAOU,QAAP,CAAgBP,QAAhB;AARJ,EAAP;AAUA,CAZD;;AAcA,IAAMQ,2BAA2B,SAA3BA,wBAA2B;AAAA,QAAY;AAC5CC,UAAQ,IAAI,EAAJ,GAAS,EAAT,GAAc,EAAd,GAAmB,IADiB,EACX;AACjCC,YAAU,IAFkC;AAG5CC,UAAQ,IAHoC;AAI5CC,UAAQC,OAJoC;AAK5CC,YAAU;AALkC,EAAZ;AAAA,CAAjC;;AAQA,IAAMC,cAAc,SAAdA,WAAc,CAACC,GAAD,EAAMC,GAAN,EAAWC,GAAX,EAAmB;AACtC,mBAAQC,KAAR,uCACqCH,IAAII,GADzC,mBAC0DF,IAAIlB,QAAJ,EAD1D;AAGA,KAAIkB,IAAIG,KAAR,EAAe;AACd,oBAAQF,KAAR,CAAcD,IAAIG,KAAlB;AACA;AACDJ,KAAIK,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBL,IAAIM,OAAJ,GAAcN,IAAIM,OAAlB,GAA4BN,GAAjD;AACA,CARD;;AAUA,IAAMO,aAAa,SAAbA,UAAa,CAACC,KAAD,EAAQC,QAAR,EAAmC;AAAA,KAAjBC,OAAiB,uEAAP,EAAO;;AACrD,KAAMC,OAAO,4BACZ;AAAA;AAAA,IAAU,OAAOH,KAAjB;AACC;AAAA;AAAA,KAAc,UAAUC,QAAxB,EAAkC,SAASC,OAA3C;AACC;AADD;AADD,EADY,CAAb;;AAQA,QAAOC,IAAP;AACA,CAVD;;AAYA,IAAMC,iBAAiB,SAAjBA,cAAiB,eAAgB;AACtC,KAAIC,cAAc;AACjBC,cAAY,EADK;AAEjBC,YAAU,EAFO;AAGjBC,cAAY,EAHK;AAIjBC,YAAU;AAJO,EAAlB;;AAOA,KAAIC,gBAAgBA,aAAaC,MAAb,GAAsB,CAA1C,EAA6C;AAC5CN,cAAYC,UAAZ,GAAyBI,aACvBE,MADuB,CAChB;AAAA,UAAKC,EAAEC,KAAF,KAAY,YAAjB;AAAA,GADgB,EAEvBC,GAFuB,CAEnB;AAAA,UAAKF,EAAEG,KAAP;AAAA,GAFmB,EAGvBC,IAHuB,CAGlB,IAHkB,CAAzB;AAIAZ,cAAYE,QAAZ,GAAuBG,aACrBE,MADqB,CACd;AAAA,UAAKC,EAAEC,KAAF,KAAY,UAAjB;AAAA,GADc,EAErBC,GAFqB,CAEjB;AAAA,UAAKF,EAAEG,KAAP;AAAA,GAFiB,EAGrBC,IAHqB,CAGhB,IAHgB,CAAvB;AAIAZ,cAAYG,UAAZ,GAAyBE,aACvBE,MADuB,CAChB;AAAA,UAAKC,EAAEC,KAAF,KAAY,YAAjB;AAAA,GADgB,EAEvBC,GAFuB,CAEnB;AAAA,UAAKF,EAAEG,KAAP;AAAA,GAFmB,EAGvBC,IAHuB,CAGlB,IAHkB,CAAzB;AAIAZ,cAAYI,QAAZ,GAAuBC,aACrBE,MADqB,CACd;AAAA,UAAKC,EAAEC,KAAF,KAAY,UAAjB;AAAA,GADc,EAErBC,GAFqB,CAEjB;AAAA,UAAKF,EAAEG,KAAP;AAAA,GAFiB,EAGrBC,IAHqB,CAGhB,IAHgB,CAAvB;AAIA;;AAED,QAAOZ,WAAP;AACA,CA5BD;;AA8BA,IAAMa,aAAa,SAAbA,UAAa,CAAC5B,GAAD,EAAMC,GAAN,EAAWS,KAAX,EAAkBmB,SAAlB,EAA6BT,YAA7B,EAA8C;AAChE,KAAMU,UAAUrB,WAAWC,KAAX,EAAkBV,IAAII,GAAtB,CAAhB;AACA,KAAM2B,QAAQrB,MAAMsB,QAAN,EAAd;AACA,KAAMC,OAAOrD,SAAb;AACA,KAAMmC,cAAcD,eAAeM,YAAf,CAApB;;AAEA,KAAMP,OAAO,yBACXqB,OADW,CACH,0BADG,EACyBnB,YAAYC,UADrC,EAEXkB,OAFW,CAEH,wBAFG,EAEuBnB,YAAYE,QAFnC,EAGXiB,OAHW,CAGH,0BAHG,EAGyBnB,YAAYG,UAHrC,EAIXgB,OAJW,CAIH,wBAJG,EAIuBnB,YAAYI,QAJnC,EAKXe,OALW,CAKH,YALG,EAKW,mBAAezD,QAL1B,EAMXyD,OANW,CAMH,SANG,EAMQD,KAAKlD,KANb,EAOXmD,OAPW,CAOH,QAPG,EAOOD,KAAKhD,IAPZ,EAQXiD,OARW,CAQH,QARG,EAQOD,KAAK/C,IARZ,EASXgD,OATW,CASH,UATG,EASSD,KAAK9C,MATd,EAUX+C,OAVW,CAUH,YAVG,EAUWC,KAAKC,SAAL,CAAeP,SAAf,CAVX,EAWXK,OAXW,CAWH,aAXG,EAWYC,KAAKC,SAAL,CAAeL,KAAf,CAXZ,EAYXG,OAZW,CAYH,OAZG,EAYMJ,OAZN,CAAb;;AAcA,KAAMjC,UAAUG,IAAIqC,QAAJ,KAAiB,OAAjC;AACA,KAAMC,WAActC,IAAIqC,QAAlB,WAAgCrC,IAAIuC,QAApC,GAA+CvC,IAAII,GAAzD;AACA,KAAMoC,eACLxC,IAAIyC,GAAJ,CAAQ,UAAR,MAAwBC,SAAxB,GAAoC,EAApC,GAAyC1C,IAAIyC,GAAJ,CAAQ,UAAR,CAD1C;AAEA,KAAME,0BAA0BnD,yBAAyBK,OAAzB,CAAhC;;AAEA,KAAI,CAACG,IAAI4C,aAAJ,CAAkBJ,YAAvB,EAAqC;AACpCvC,MAAI4C,MAAJ,CAAW,cAAX,EAA2BL,YAA3B,EAAyCG,uBAAzC;AACA;;AAED,KAAI,CAAC3C,IAAI4C,aAAJ,CAAkBE,WAAvB,EAAoC;AACnC7C,MAAI4C,MAAJ,CAAW,aAAX,EAA0BP,QAA1B,EAAoCK,uBAApC;AACA;;AAED,KAAMI,iBAAiBhB,MAAMiB,GAAN,CAAUC,WAAV,CAAsBC,IAAtB,KAA+B,GAA/B,GAAqC,GAArC,GAA2C,GAAlE;AACAjD,KAAIK,MAAJ,CAAWyC,cAAX,EAA2BxC,IAA3B,CAAgCM,IAAhC;AACA,CApCD;;AAsCA,IAAMsC,gBAAgB,SAAhBA,aAAgB,CAACnD,GAAD,EAAMC,GAAN,EAAc;AACnC,2BAAUD,GAAV,EAAe,mBAAevB,QAA9B,EACE2E,IADF,CACO,gBAAwC;AAAA,MAArCrB,KAAqC,QAArCA,KAAqC;AAAA,MAA9BF,SAA8B,QAA9BA,SAA8B;AAAA,MAAnBT,YAAmB,QAAnBA,YAAmB;;AAC7C,2BAAa;AACZiC,kBAAetB,MAAMiB,GAAN,CAAUK,aADb;AAEZC,SAAMzB;AAFM,GAAb;AAIA,MAAMnB,QAAQ,4CAEbqB,KAFa,EAGb,iDAHa,CAAd;AAKAH,aAAW5B,GAAX,EAAgBC,GAAhB,EAAqBS,KAArB,EAA4BmB,SAA5B,EAAuCT,YAAvC;AACA,EAZF,EAaEmC,KAbF,CAaQ,eAAO;AACbxD,cAAYC,GAAZ,EAAiBC,GAAjB,EAAsBC,GAAtB;AACA,EAfF;AAgBA,CAjBD;;kBAmBeiD,a","file":"pageRendering.js","sourcesContent":["import winston from 'winston';\nimport CezerinClient from 'cezerin-client';\nimport React from 'react';\nimport { StaticRouter } from 'react-router';\nimport { renderToString } from 'react-dom/server';\nimport { createStore, applyMiddleware } from 'redux';\nimport thunkMiddleware from 'redux-thunk';\nimport { Provider } from 'react-redux';\nimport Helmet from 'react-helmet';\nimport { initOnServer } from 'theme';\nimport serverSettings from './settings';\nimport reducers from '../shared/reducers';\nimport { loadState } from './loadState';\nimport { indexHtml } from './readIndexHtml';\nimport App from '../shared/app';\n\ninitOnServer({\n\tlanguage: serverSettings.language,\n\tapi: new CezerinClient({\n\t\tajaxBaseUrl: serverSettings.ajaxBaseUrl\n\t})\n});\n\nconst getHead = () => {\n\tconst helmet = Helmet.rewind();\n\treturn {\n\t\ttitle: helmet.title.toString(),\n\t\tmeta: helmet.meta.toString(),\n\t\tlink: helmet.link.toString(),\n\t\tscript: helmet.script.toString(),\n\t\tstyle: helmet.style.toString(),\n\t\thtmlAttributes: helmet.htmlAttributes.toString(),\n\t\tbase: helmet.base.toString(),\n\t\tnoscript: helmet.noscript.toString()\n\t};\n};\n\nconst getReferrerCookieOptions = isHttps => ({\n\tmaxAge: 7 * 24 * 60 * 60 * 1000, // 7 days\n\thttpOnly: true,\n\tsigned: true,\n\tsecure: isHttps,\n\tsameSite: 'strict'\n});\n\nconst renderError = (req, res, err) => {\n\twinston.error(\n\t\t`Error on page rendering\\n\\tpath: ${req.url}\\n\\terror: ${err.toString()}`\n\t);\n\tif (err.stack) {\n\t\twinston.error(err.stack);\n\t}\n\tres.status(500).send(err.message ? err.message : err);\n};\n\nconst getAppHtml = (store, location, context = {}) => {\n\tconst html = renderToString(\n\t\t<Provider store={store}>\n\t\t\t<StaticRouter location={location} context={context}>\n\t\t\t\t<App />\n\t\t\t</StaticRouter>\n\t\t</Provider>\n\t);\n\n\treturn html;\n};\n\nconst getPlaceholder = placeholders => {\n\tlet placeholder = {\n\t\thead_start: '',\n\t\thead_end: '',\n\t\tbody_start: '',\n\t\tbody_end: ''\n\t};\n\n\tif (placeholders && placeholders.length > 0) {\n\t\tplaceholder.head_start = placeholders\n\t\t\t.filter(p => p.place === 'head_start')\n\t\t\t.map(p => p.value)\n\t\t\t.join('\\n');\n\t\tplaceholder.head_end = placeholders\n\t\t\t.filter(p => p.place === 'head_end')\n\t\t\t.map(p => p.value)\n\t\t\t.join('\\n');\n\t\tplaceholder.body_start = placeholders\n\t\t\t.filter(p => p.place === 'body_start')\n\t\t\t.map(p => p.value)\n\t\t\t.join('\\n');\n\t\tplaceholder.body_end = placeholders\n\t\t\t.filter(p => p.place === 'body_end')\n\t\t\t.map(p => p.value)\n\t\t\t.join('\\n');\n\t}\n\n\treturn placeholder;\n};\n\nconst renderPage = (req, res, store, themeText, placeholders) => {\n\tconst appHtml = getAppHtml(store, req.url);\n\tconst state = store.getState();\n\tconst head = getHead();\n\tconst placeholder = getPlaceholder(placeholders);\n\n\tconst html = indexHtml\n\t\t.replace('{placeholder_head_start}', placeholder.head_start)\n\t\t.replace('{placeholder_head_end}', placeholder.head_end)\n\t\t.replace('{placeholder_body_start}', placeholder.body_start)\n\t\t.replace('{placeholder_body_end}', placeholder.body_end)\n\t\t.replace('{language}', serverSettings.language)\n\t\t.replace('{title}', head.title)\n\t\t.replace('{meta}', head.meta)\n\t\t.replace('{link}', head.link)\n\t\t.replace('{script}', head.script)\n\t\t.replace('{app_text}', JSON.stringify(themeText))\n\t\t.replace('{app_state}', JSON.stringify(state))\n\t\t.replace('{app}', appHtml);\n\n\tconst isHttps = req.protocol === 'https';\n\tconst full_url = `${req.protocol}://${req.hostname}${req.url}`;\n\tconst referrer_url =\n\t\treq.get('referrer') === undefined ? '' : req.get('referrer');\n\tconst REFERRER_COOKIE_OPTIONS = getReferrerCookieOptions(isHttps);\n\n\tif (!req.signedCookies.referrer_url) {\n\t\tres.cookie('referrer_url', referrer_url, REFERRER_COOKIE_OPTIONS);\n\t}\n\n\tif (!req.signedCookies.landing_url) {\n\t\tres.cookie('landing_url', full_url, REFERRER_COOKIE_OPTIONS);\n\t}\n\n\tconst httpStatusCode = state.app.currentPage.type === 404 ? 404 : 200;\n\tres.status(httpStatusCode).send(html);\n};\n\nconst pageRendering = (req, res) => {\n\tloadState(req, serverSettings.language)\n\t\t.then(({ state, themeText, placeholders }) => {\n\t\t\tinitOnServer({\n\t\t\t\tthemeSettings: state.app.themeSettings,\n\t\t\t\ttext: themeText\n\t\t\t});\n\t\t\tconst store = createStore(\n\t\t\t\treducers,\n\t\t\t\tstate,\n\t\t\t\tapplyMiddleware(thunkMiddleware)\n\t\t\t);\n\t\t\trenderPage(req, res, store, themeText, placeholders);\n\t\t})\n\t\t.catch(err => {\n\t\t\trenderError(req, res, err);\n\t\t});\n};\n\nexport default pageRendering;\n"]}